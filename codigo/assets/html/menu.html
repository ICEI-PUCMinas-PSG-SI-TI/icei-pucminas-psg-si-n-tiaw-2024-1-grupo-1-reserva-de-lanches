<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu da Lanchonete</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">

</head>

<body>

    <header class="container mt-3">
        <div>
            <nav>
                <h1 href="" class="title ps-3 text-white">Menu da Lanchonete</h1>

                <ul class="nav-list mb-0 justify-content-end">
                    <!-- <li>Início</li> -->
                    <li><a href="historicoDePedidosFeitos.html" class="text-decoration-none text-light">Histórico de pedidos</a></li>
                    <li><a href="finalizarPedido.html" class="text-decoration-none text-light">Finalizar pedidos</a></li>
                    <li><a href="perfil.html" class="text-decoration-none text-light">Perfil</a></li>
                    <li class="text-decoration-none text-light" onclick="logOff()">Sair</li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="container mt-3">
     
        <!-- Itens do menu -->
        <div id="menu-items" class="d-flex mb-5">
            <div class="itens d-flex flex-column tamanho">
                <h2>Produtos</h2>
                <div class="menu-category" id="Produtos">
                    <!-- <div class="menu-item d-flex">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhkoNbV9SkABi_6ZnMjxIiqKDdvyI7hNpewpmvezY_WAHgIa18cSYI9-iEFKPEA5Gab_eIEXjoWZX1hid6SsGLsU57IsfdVzT3xi7oBIarwUFLMJ4R4D7vfCvKh_UG5dIC1PNa_MSplPVdvO0VLqeIVmFTd82YZuKExqtBk8wF6Yv79NBRbvTzsXFed/s2000/receita-de-sandu%C3%ADche-natural-light.jpg"
                            alt="Sanduíche Natural">
                        <div class="d-flex flex-wrap justify-content-between w-100">
                            <div class="menu-item-content">
                                <h2>Sanduíche Natural</h2>
                                <p class="mb-0">Valor: R$6,50</p>
    
                            </div>
                            <div class="d-flex align-itens-center align-self-center ps-3 mb-2 me-5 ">
                                <button type="button" class="btn btn-dark addCarrinho"  valor="6.50" nome="Sanduiche Natural">Add to
                                    Cart</button>
    
                            </div>
                        </div>
                    </div> -->
                  

                </div>
                           
                           
            </div>
                <!-- Seção do carrinho -->
                <div class="cart d-flex flex-column tamanho-2 ps-3">
                    <div class="sticky-top">
                        <h2>Carrinho</h2>
                        <div id="order-summary"></div>
                        <p id="total-price">Total: R$0.00</p>
                        <button class="btn btn-dark meu-botao w-100" type="button" onclick="mostrarPedido()">
                            Salvar Pedido
                        </button>
                        
                    </div>

                </div>

            </div>
</body>
    
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        //cria o carrinho

        let dbMock = {
            tipo: ['Comidas', 'Bebidas', 'Doces'],
            proximoID: 20,
            items: [
                {
                    id: 1,
                    tipo: 'Comidas',
                    descricao: 'Sanduíche Natural',
                    preco: 6.50,
                    estoque: 5,
                    img: '../img/sanduiche-natural.jpg'
                },
                {
                    id: 2,
                    tipo: 'Comidas',
                    descricao: 'Coxinha',
                    preco: 6.50,
                    estoque: 15,
                    img: '../img/coxinha.jpg'
                },
                {
                    id: 3,
                    tipo: 'Comidas',
                    descricao: 'Empada',
                    preco: 6.50,
                    estoque: 10,
                    img: '../img/empada.jpg'
                },
                {
                    id: 4,
                    tipo: 'Comidas',
                    descricao: 'Pão de Queijo',
                    preco: 3.00,
                    estoque: 15,
                    img: '../img/pao-de-queijo.jpg'
                },
                {
                    id: 5,
                    tipo: 'Comidas',
                    descricao: 'Pão de Queijo Recheado',
                    preco: 5.00,
                    estoque: 10,
                    img: '../img/pao-de-queijo-recheado.jpg'
                },
                {
                    id: 6,
                    tipo: 'Comidas',
                    descricao: 'Pastel Assado',
                    preco: 6.50,
                    estoque: 10,
                    img: '../img/pastel-assado.jpg'
                },
                {
                    id: 7,
                    tipo: 'Comidas',
                    descricao: 'Hamburgão',
                    preco: 8.00,
                    estoque: 5,
                    img: '../img/hamburgao.jpg'
                },
                {
                    id: 8,
                    tipo: 'Comidas',
                    descricao: 'Enrolado de Presunto e Queijo',
                    preco: 6.50,
                    estoque: 10,
                    img: '../img/enrolado-presunto-queijo.jpg'
                },
                {
                    id: 9,
                    tipo: 'Comidas',
                    descricao: 'Enrolado de Salsicha',
                    preco: 6.50,
                    estoque: 5,
                    img: '../img/enrolado-salsicha.jpg'
                },
                {
                    id: 10,
                    tipo: 'Comidas',
                    descricao: 'Hambúrguer',
                    preco: 12.00,
                    estoque: 5,
                    img: '../img/hamburguer.png'
                },
                {
                    id: 11,
                    tipo: 'Comidas',
                    descricao: 'Batata Frita',
                    preco: 15.00,
                    estoque: 5,
                    img: '../img/batata-frita.jpg'
                },
                {
                    id: 12,
                    tipo: 'Bebidas',
                    descricao: 'Refrigerantes',
                    preco: 6.00,
                    estoque: 30,
                    img: '../img/refrigerantes.jpg'
                },
                {
                    id: 13,
                    tipo: 'Bebidas',
                    descricao: 'Sucos',
                    preco: 6.50,
                    estoque: 20,
                    img: '../img/sucos.jpg'
                },
                {
                    id: 14,
                    tipo: 'Bebidas',
                    descricao: 'Vitaminas',
                    preco: 7.50,
                    estoque: 20,
                    img: '../img/vitaminas.jpg'
                },
                {
                    id: 15,
                    tipo: 'Bebidas',
                    descricao: 'Água',
                    preco: 4.50,
                    estoque: 50,
                    img: '../img/agua-mineral.jpeg'
                },
                {
                    id: 16,
                    tipo: 'Bebidas',
                    descricao: 'Energético',
                    preco: 12.00,
                    estoque: 15,
                    img: '../img/energeticos.jpg'
                },
                {
                    id: 17,
                    tipo: 'Doces',
                    descricao: 'Bombom',
                    preco: 3.00,
                    estoque: 50,
                    img: '../img/bombom.jpg'
                },
                {
                    id: 18,
                    tipo: 'Doces',
                    descricao: 'Balas',
                    preco: 0.25,
                    estoque: 100,
                    img: '../img/balas.jpg'
                },
                {
                    id: 19,
                    tipo: 'Doces',
                    descricao: 'Chicletes',
                    preco: 2.50,
                    estoque: 50,
                    img: '../img/chicletes.jpg'
                },
            ]
        };

        let dbProdutos = {};

        function loadProducts() {
            dbProdutos = JSON.parse(localStorage.getItem('dbProdutos'));

            if (!dbProdutos) {
                dbProdutos = dbMock;
                localStorage.setItem('dbProdutos', JSON.stringify(dbProdutos));
            }

            let html = ''

            dbProdutos.items.forEach(produto => {
                html += `
                    <div class="menu-item d-flex">
                        <img src="${produto.img}"
                            alt="${produto.descricao}">
                        <div class="d-flex flex-wrap justify-content-between w-100">
                            <div class="menu-item-content">
                                <h4>${produto.descricao}</h4>
                                <p class="mb-0">Valor: R$${parseFloat(produto.preco).toFixed(2)}</p>
    
                            </div>
                            <div class="d-flex align-itens-center align-self-center ps-3 mb-2 me-5 ">
                                <button type="button" class="btn btn-dark addCarrinho"  valor="${produto.preco}" nome="${produto.descricao}">Add to
                                    Cart</button>
    
                            </div>
                        </div>
                    </div>
                
                `
            })

            $('#Produtos').html(html)

            // console.log(dbProdutos.items)

        }

        var carrinho = [];
        $(document).ready(function() {
            loadProducts()
            
            var quantidade = 1;
            var html = "";
            var total = 0;

            //remove um item do carrinho
            function removeItem(itemNome) {
                total = 0;
                html = '';
                carrinho.forEach((compra, index) => {
                    if (compra.nome === itemNome) {
                        compra.quantidade = compra.quantidade - 1;
                        if(compra.quantidade == 0){
                            carrinho.splice(index, 1);
                        }
                    } 
                    
                });
                carrinho.forEach((compra, index)=>{
                    html += `<div class='shadow p-2 mb-1 bg-white rounded d-flex align-items-center text-center'>
                                <p class='m-0'>${compra.nome}: ${compra.quantidade}x</p>
                                <button class='btn btn-danger p-1 px-2 ms-auto remove-item' data-item="${index}">
                                    <i class="bi bi-dash"></i>
                                </button>
                            </div>`;
                    total += compra.preco
                })

                $('#order-summary').html(html);
                $('#total-price').text(`Total: R$${total.toFixed(2)}`);
            }

            //adiciona itens a carrinho
            $('.addCarrinho').click(function() {
                let nome = $(this).attr('nome');
                let preco = parseFloat($(this).attr('valor'));

                let itemExiste = false;
                carrinho.forEach(compra => {
                    if (compra.nome === nome) {
                        compra.quantidade += 1;
                        itemExiste = true;
                    }
                });

                if (!itemExiste) {
                    carrinho.push({
                        nome: nome,
                        preco: preco,
                        quantidade: quantidade
                    });
                }

                total = 0;
                html = '';
                carrinho.forEach((compra, index) => {
                    total += compra.preco * compra.quantidade;
                    html += `<div class='shadow p-2 mb-1 bg-white rounded d-flex align-items-center text-center'>
                                <p class='m-0'>${compra.nome}: ${compra.quantidade}x</p>
                                <button class='btn btn-danger p-1 px-2 ms-auto remove-item' data-item="${index}">
                                    <i class="bi bi-dash"></i>
                                </button>
                            </div>`;
                });

                $('#order-summary').html(html);
                $('#total-price').text(`Total: R$${total.toFixed(2)}`);
            });

            // Evento delegado para lidar com cliques nos botões de remoção
            $('#order-summary').on('click', '.remove-item', function() {
                let index = $(this).data('item');
                let nomeItem = carrinho[index].nome;
                removeItem(nomeItem);
            });

            // Recarrega a págian de produtos toda vez que perceber uma alteração no banco de dados
            setInterval(atualizarMenu, 1000);
        });

        function atualizarMenu() {
            let updateDataBase = JSON.parse(localStorage.getItem('updateDataBase'));

            if (!updateDataBase) {
                updateDataBase = { reload: false };
                localStorage.setItem('updateDataBase', JSON.stringify(updateDataBase));
            }

            if (updateDataBase.reload == true) {
                // Reseta o Flag
                updateDataBase = { reload: false };
                localStorage.setItem('updateDataBase', JSON.stringify(updateDataBase));
                
                window.open('menu.html', '_self');
            }
        }

        function gerarIdUnico() {
            return '' + Date.now();
        }

        function mostrarPedido() {
            let usuar = JSON.parse(sessionStorage.getItem('loggedInUser'));
            // var usuar = JSON.parse(localStorage.getItem('userList'))[0];
            console.log(carrinho);
            
            let pedidoId = gerarIdUnico();

            let pedidoComEmail = { id: pedidoId, carrinho: carrinho, email: usuar.email, status: "pendente" };
            
            let pedidos = localStorage.getItem('pedidos');
            
            if (!pedidos) {
                pedidos = [];
            } else {
                pedidos = JSON.parse(pedidos);
            }
            
            pedidos.push(pedidoComEmail);
            
            localStorage.setItem('pedidos', JSON.stringify(pedidos));

            alert('Pedido adicionado ao histórico');

            window.open('finalizarPedido.html', '_self');
        }

        // Função para filtrar os itens por categoria
        function filterItems(category) {
            const categories = document.querySelectorAll('.menu-category');
            categories.forEach(cat => {
                if (cat.id === category) {
                    cat.style.display = 'block';
                } else {
                    cat.style.display = 'none';
                }
            });
        }

        function logOff() {
            sessionStorage.removeItem('loggedInUser');
            window.open("../../index.html", '_self');
        }

    </script>
</html>